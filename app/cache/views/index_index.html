<!DOCTYPE html>
<html>
    <head>
		<meta charset="utf-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<meta name="description" content="Расходы города"/>
		<meta name="author" content="Porgibnoy"/>
		<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
		<!-- для соцсетей 
		<meta property="og:image" content="http:///img/logo.png" />
		<meta property="og:title" content="Новость!" />
		<meta property="og:description" content="Опросы на сайте " />-->
		
		<!--<title>##Наименование сайта</title>-->
		
		<link rel="shortcut icon" type="image/png" href="/favicon.png"/>
		<!--<link rel="shortcut icon" type="image/png" href="/favicon.png"/>-->
		
		<link rel="stylesheet" type="text/css" media="all" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous"/>
		<link rel="stylesheet" type="text/css" media="all" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css"/>	
		<link rel="stylesheet" type="text/css" media="all" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css">
		<link rel="stylesheet" type="text/css" media="all" href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-theme/0.1.0-beta.9/select2-bootstrap.min.css">
		
    </head>
    <body>
		<div class="container">
			<!--<br>layouts\index-->
<!--<br>layouts\menu-->

<nav class="navbar navbar-default" role="navigation">
	<div class="container-fluid">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
		  <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
			<span class="sr-only">Навигация</span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
		  </button>
		  <a class="navbar-brand" href="/">Расходы города</a>
		</div>
		
		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse navbar-left" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/index">Главная</a></li>
				<li class=""><a href="/newslist">Новости</a></li>
				<!--<li class=""><a href="/expensetypelist">Общая статистика</a></li>-->
				<li class=""><a href="/about">О проекте</a></li>			
				<!--<li class="" data-toggle="modal" data-target="#supportRequestModal"><a href="#" >Обращение в службу поддержки</a></li>-->
			</ul>
		</div><!-- /.navbar-collapse -->
		<!--<div class="controls controls-row navbar-right">
			<ul class="nav navbar-nav">
				<div id="authButtons">
					<span name="userName">">Регистрация</button>
				</div>
			</ul>
		</div>-->
	</div><!-- /.container-fluid -->
</nav>

<script type="text/javascript"><!--

//--></script>
<div class="row-fluid">
	<h1 class="page-header">Интернет портал общедоступной информации о расходах муниципальных образований «Расходы города»</h1>
</div><!-- /.row-fluid -->
	
<div class="row-fluid">
	<div id="entity_form_placeholder"></div>
	<div id="scroller_form_placeholder"></div>
	
	<div class="row"><div class="col-lg-12"><div>&nbsp;</div></div></div>
<div class="row"><div class="col-lg-12"><div>&nbsp;</div></div></div>
<div class="row"><div class="col-lg-12"><div>&nbsp;</div></div></div>
<div class="row">
	<form class="form-horizontal">
		<div class="form-group">
			<label for="regionSelect" class="col-lg-3 control-label">Выберите регион</label>
			<div class="col-lg-8">
				<select id="regionSelect" class="form-control extended" onchange="onRegionChange(this);">
					<option value="*" selected="selected"></option>
												<option value="21">Астраханская область</option>
													<option value="20">Владимирская область</option>
															<select>
				<!--<input type="region" class="form-control" id="inputRegion" placeholder="Регион">-->
			</div>
		</div>
		<div class="form-group">
			<label for="organizationSelect" class="col-lg-3 control-label">Выберите населенный пункт</label>
			<div class="col-lg-8">
				<select id="organizationSelect" class="form-control extended" onchange="onOrganizationChange(this);">
					<option value="*" selected="selected"></option>
												<option value="38">Александров (Владимирская область)</option>
													<option value="36">Владимир (Владимирская область)</option>
													<option value="35">Вязники (Владимирская область)</option>
													<option value="34">Гороховец (Владимирская область)</option>
													<option value="33">Гусь-Хрустальный (Владимирская область)</option>
													<option value="30">Камешково (Владимирская область)</option>
													<option value="28">Карабаново (Владимирская область)</option>
													<option value="27">Киржач (Владимирская область)</option>
													<option value="26">Ковров (Владимирская область)</option>
													<option value="25">Кольчугино (Владимирская область)</option>
													<option value="24">Костерёво (Владимирская область)</option>
													<option value="23">Курлово (Владимирская область)</option>
													<option value="22">Лакинск (Владимирская область)</option>
													<option value="21">Меленки (Владимирская область)</option>
													<option value="2">Муром (Владимирская область)</option>
													<option value="1">Петушки (Владимирская область)</option>
													<option value="40">Покров (Владимирская область)</option>
													<option value="41">Радужный (Владимирская область)</option>
													<option value="42">Собинка (Владимирская область)</option>
													<option value="43">Струнино (Владимирская область)</option>
													<option value="44">Судогда (Владимирская область)</option>
													<option value="45">Суздаль (Владимирская область)</option>
													<option value="46">Юрьев-Польский (Владимирская область)</option>
															<select>
			</div>
		</div>
		<div class="form-group">
			<div class="col-lg-offset-3 col-lg-10">
				<button id="showExpenses" type="button" class="btn btn-default" disabled onclick="onShowExpensesClick();">Перейти</button>
			</div>
		</div>
	</form>
</div>

<script type="text/javascript"><!--

var regions = {"21":"\u0410\u0441\u0442\u0440\u0430\u0445\u0430\u043d\u0441\u043a\u0430\u044f \u043e\u0431\u043b\u0430\u0441\u0442\u044c","20":"\u0412\u043b\u0430\u0434\u0438\u043c\u0438\u0440\u0441\u043a\u0430\u044f \u043e\u0431\u043b\u0430\u0441\u0442\u044c"};
var organizations = {"38":{"name":"\u0410\u043b\u0435\u043a\u0441\u0430\u043d\u0434\u0440\u043e\u0432","regionID":"20"},"36":{"name":"\u0412\u043b\u0430\u0434\u0438\u043c\u0438\u0440","regionID":"20"},"35":{"name":"\u0412\u044f\u0437\u043d\u0438\u043a\u0438","regionID":"20"},"34":{"name":"\u0413\u043e\u0440\u043e\u0445\u043e\u0432\u0435\u0446","regionID":"20"},"33":{"name":"\u0413\u0443\u0441\u044c-\u0425\u0440\u0443\u0441\u0442\u0430\u043b\u044c\u043d\u044b\u0439","regionID":"20"},"30":{"name":"\u041a\u0430\u043c\u0435\u0448\u043a\u043e\u0432\u043e","regionID":"20"},"28":{"name":"\u041a\u0430\u0440\u0430\u0431\u0430\u043d\u043e\u0432\u043e","regionID":"20"},"27":{"name":"\u041a\u0438\u0440\u0436\u0430\u0447","regionID":"20"},"26":{"name":"\u041a\u043e\u0432\u0440\u043e\u0432","regionID":"20"},"25":{"name":"\u041a\u043e\u043b\u044c\u0447\u0443\u0433\u0438\u043d\u043e","regionID":"20"},"24":{"name":"\u041a\u043e\u0441\u0442\u0435\u0440\u0451\u0432\u043e","regionID":"20"},"23":{"name":"\u041a\u0443\u0440\u043b\u043e\u0432\u043e","regionID":"20"},"22":{"name":"\u041b\u0430\u043a\u0438\u043d\u0441\u043a","regionID":"20"},"21":{"name":"\u041c\u0435\u043b\u0435\u043d\u043a\u0438","regionID":"20"},"2":{"name":"\u041c\u0443\u0440\u043e\u043c","regionID":"20"},"1":{"name":"\u041f\u0435\u0442\u0443\u0448\u043a\u0438","regionID":"20"},"40":{"name":"\u041f\u043e\u043a\u0440\u043e\u0432","regionID":"20"},"41":{"name":"\u0420\u0430\u0434\u0443\u0436\u043d\u044b\u0439","regionID":"20"},"42":{"name":"\u0421\u043e\u0431\u0438\u043d\u043a\u0430","regionID":"20"},"43":{"name":"\u0421\u0442\u0440\u0443\u043d\u0438\u043d\u043e","regionID":"20"},"44":{"name":"\u0421\u0443\u0434\u043e\u0433\u0434\u0430","regionID":"20"},"45":{"name":"\u0421\u0443\u0437\u0434\u0430\u043b\u044c","regionID":"20"},"46":{"name":"\u042e\u0440\u044c\u0435\u0432-\u041f\u043e\u043b\u044c\u0441\u043a\u0438\u0439","regionID":"20"}};

function onRegionChange(ctrl) {
	var regID = ctrl.value;
	
	var selectOrgs = $("#organizationSelect").empty();
	var optionsHTML = '<option value="*" selected="selected"></option>';
	if(regID == '*') {
		for (var id in organizations) {
			var org = organizations[id];
			optionsHTML += '<option value="' + id + '">' + org.name + ' (' + regions[org['regionID']] + ')</option>';
		}
	}
	else {
		for (var id in organizations) {
			var org = organizations[id];
			if(org.regionID == regID) optionsHTML += '<option value="' + id + '">' + org.name + ' (' + regions[org['regionID']] + ')</option>';
		}
	}
	selectOrgs.append(optionsHTML);
	//selectOrgs.select2();
	//selectOrgs.on("select2:select", onOrganizationSelect);
}

function onOrganizationChange(ctrl) {
	var orgID = ctrl.value;
	if(orgID == '*') $('#showExpenses').prop('disabled', true);
	else $('#showExpenses').prop('disabled', false);
}

function onShowExpensesClick() {
	var orgID = $("#organizationSelect").val();
	if(orgID == '*') { $('#showExpenses').prop('disabled', true); return; }
	
	document.location = '/organization?id='+orgID;
}
//--></script></div><!-- /.row-fluid -->

<script type="text/javascript"><!--
//--></script>

<!-- Модальные окна -->
<div class="modal fade" id="logonModal" tabindex="-1" role="dialog" aria-labelledby="logonModalHeader">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" id="logonModalHeader">Добро пожаловать</h4>
			</div>
			<div class="modal-body">
				<div class="row">
					<div class="col-lg-offset-1 col-lg-10 center-block">
						<div class="form-signin">
							<h2 class="form-signin-heading text-center">Авторизация</h2>
							<div class="input-group">
								<span class="input-group-addon"><i class="glyphicon glyphicon-envelope"></i></span>
								<input type="email" id="email" class="form-control" placeholder="Email" autofocus="">
							</div>
							<div class="row"><div class="col-lg-12 text-center">ИЛИ</div></div>
							<div class="input-group">
									<span class="input-group-addon"><i class="glyphicon glyphicon-phone-alt"></i></span>
									<input id="phone" type="tel" class="form-control" name="phone" value="" placeholder="Телефон" pattern="[0-9]+" maxlength="12">                                        
							</div>
							<div class="row"><div class="col-lg-12 text-center">&nbsp;</div></div>
							<div class="input-group">
								<span class="input-group-addon"><i class="glyphicon glyphicon-lock"></i></span>
								<input id="password" type="password" class="form-control" name="password" value="" required="" placeholder="Пароль">                                        
							</div>
							<div class="checkbox">
								<label>
									<input type="checkbox" value="remember-me"> Запомнить меня
								</label>
							</div>
							<!--<button class="btn btn-lg btn-primary btn-block" type="submit" formmethod="get" formaction="/session/start">Войти</button>-->
							<button type="button" class="btn btn-primary btn-block" onclick="frontendLogin();">Войти</button>
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<!--<button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>-->
			</div>
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div>
<div class="modal fade" id="registerModal" tabindex="-1" role="dialog" aria-labelledby="registerModalHeader">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" id="registerModalHeader">Добро пожаловать</h4>
			</div>
			<div class="modal-body">
				<div class="row">
					<div class="col-lg-offset-1 col-lg-10 center-block">
						<!-- wizard: http://vadimg.com/twitter-bootstrap-wizard-example/#examples -->
						<div class="form-signin">
							<h2 class="form-signin-heading text-center">Регистрация</h2>
							<div class="input-group">
								<span class="input-group-addon"><i class="glyphicon glyphicon-envelope"></i></span>
								<input type="email" id="email" class="form-control" placeholder="Email" autofocus="">
							</div>
							<div class="row"><div class="col-lg-12 text-center">И/ИЛИ</div></div>
							<div class="input-group">
									<span class="input-group-addon"><i class="glyphicon glyphicon-phone-alt"></i></span>
									<input id="phone" type="tel" class="form-control" name="phone" value="" placeholder="Телефон" pattern="[0-9]+" maxlength="12">                                        
							</div>
							<div class="row"><div class="col-lg-12 text-center">&nbsp;</div></div>
							<div class="input-group">
								<span class="input-group-addon"><i class="glyphicon glyphicon-lock"></i></span>
								<input id="password" type="password" class="form-control" name="password" value="" required="" placeholder="Пароль">                                        
							</div>
							<div class="row"><div class="col-lg-12 text-center">&nbsp;</div></div>
							<div class="input-group">
								<span class="input-group-addon"><i class="glyphicon glyphicon-lock"></i></span>
								<input id="password2" type="password" class="form-control" name="password2" value="" required="" placeholder="Повторите пароль">                                        
							</div>
							<div class="row"><div class="col-lg-12 text-center">&nbsp;</div></div>
							<!--<button class="btn btn-lg btn-primary btn-block" type="submit" formmethod="get" formaction="/session/start">Войти</button>-->
							<button type="button" class="btn btn-primary btn-block" onclick="register();">Зарегистрироваться</button>
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<!--<button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>-->
			</div>
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div>

<!--Запрос в службу поддержки-->
<div class="modal fade" id="supportRequestModal" tabindex="-1" role="dialog" aria-labelledby="supportRequestModalHeader">
	<div class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" id="supportRequestModalHeader">Обращение в службу поддержки</h4>
			</div>
			<div class="modal-body">
				<div class="row">
					<div class="col-lg-offset-1 col-lg-10 center-block">
						<!-- wizard: http://vadimg.com/twitter-bootstrap-wizard-example/#examples -->
						<form class="form">
							<h2 class="form-heading text-center">Вопрос</h2>
							
							<div class="row">
								<div class="col-lg-3">
									<span >Тема</span>
								</div>
								<div class="col-lg-9">
									<input type="text" id="topic" class="form-control" placeholder="" autofocus="">
								</div>
							</div>
							<div class="row"><div class="col-lg-12 text-center">&nbsp;</div></div>
							<div class="row">
								<div class="col-lg-3">
									<span >Текст обращения</span>
								</div>
								<div class="col-lg-9 text-center">
									<textarea type="request" id="request" class="form-control" placeholder="" autofocus=""></textarea>
								</div>
							</div>
							<div class="row"><div class="col-lg-12 text-center">&nbsp;</div></div>
							<div class="row">
								<div class="col-lg-3">
									<span >Направить ответ</span>
								</div>
								<div class="col-lg-9">
									<input type="text" id="topic" class="form-control" placeholder="Email" autofocus="">
								</div>                                        
							</div>
							<div class="row"><div class="col-lg-12 text-center">&nbsp;</div></div>
							<!--<button class="btn btn-lg btn-primary btn-block" type="submit" formmethod="get" formaction="/session/start">Войти</button>-->
							<button type="button" class="btn btn-primary btn-block" onclick="">Отправить</button>
						</form>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<!--<button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>-->
			</div>
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div>

<script type="text/javascript"><!--

function frontendLogin() {
	var url = '/session/start?';
	//var modal = $("#logonModal");
	var modal = $(".form-signin");
	
	var phone = modal.find('#phone').val();
	if (phone) url += 'phone=' + encodeURIComponent(phone);
	var email = modal.find('#email').val();
	if (email) url += (phone ? '&' : '') +'&email=' + encodeURIComponent(email);
	var password = modal.find('#password').val();
	password = sha1(password);
	if (password) url += '&password=' + encodeURIComponent(password);
	
	console.log(url);
	
	$.ajax({
		url: url,
		dataType: 'json',
		method: 'get',
		beforeSend: function() {
				// показываем прогрессбар
		},
		complete: function() {
			// скрываем прогрессбар
		},			
		success: function(json) {
			console.log(json);
			handleAjaxSuccess(json.success)
			if(!handleAjaxError(json.error)) {
				//if(json.success.redirect) document.location = json.success.redirect;
				location.reload();
				/*else {
					var authButtonsDiv = $('#authButtons');
					authButtonsDiv.find('[name="login"]').hide();
					authButtonsDiv.find('[name="register"]').hide();
					authButtonsDiv.find('[name="logout"]').show();
					modal.hide();
				}*/
			}
			
		},
		error: function(xhr, ajaxOptions, thrownError) {
			console.log(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
			handleAjaxError({
				messages: [{
					title: 'Ошибка обмена данными',
					msg: 'Ошибка обработки запроса на стороне сервера. Обратитесь в службу поддержки',
				}],
			});
		}
	});
}

function frontendLogout() {
	var url = '/session/end';
	console.log(url);
	$.ajax({
		url: url,
		dataType: 'json',
		method: 'get',
		beforeSend: function() {
				// показываем прогрессбар
		},
		complete: function() {
			// скрываем прогрессбар
		},			
		success: function(json) {
			console.log(json);
			handleAjaxSuccess(json.success)
			if(!handleAjaxError(json.error)) {
				//if(json.success.redirect) document.location = document.location;
				location.reload();
				/*else {
					var authButtonsDiv = $('#authButtons');
					authButtonsDiv.find('[name="logout"]').hide();
					authButtonsDiv.find('[name="login"]').show();
					authButtonsDiv.find('[name="register"]').show();
				}*/
			}
			
		},
		error: function(xhr, ajaxOptions, thrownError) {
			console.log(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
			handleAjaxError({
				messages: [{
					title: 'Ошибка обмена данными',
					msg: 'Ошибка обработки запроса на стороне сервера. Обратитесь в службу поддержки',
				}],
			});
		}
	});
}

/*function frontendSupportRequest(id){
	// родительский контейнер (скроллер), элемент которого открываем
	var container = containers[container_id];
	var scroller = container.data;
	url = '/'+scroller.entity + '/getdata';
	
		// запрашиваем с сервера пустую сущность
	$.ajax({
		url: url,
		dataType: 'json',
		method: 'get',
		beforeSend: function() {
				// показываем прогрессбар
		},
		complete: function() {
			// скрываем прогрессбар
		},			
		success: function(json) {
			if(!handleAjaxError(json.error)) {
				//console.log("С сервера получены полные данные сущности скроллера:");
				console.log(json);
				
				// сохраняем полученные данные
				var local_entity = saveFullServerEntity(json);
				//if(!id) local_entity.local_data.status = 'added';
				//local_entity.local_data.target_container_id = container.local_data.container_id;
				//if(scroller.relationType) local_entity.local_data.relationType = scroller.relationType;
				
				// присваиваем идентификаторы скролерам, чтобы при выводе основных данных сущности оставить метки для их размещения
				//initEntityScrollers(local_entity);
				
				// рисуем модалку
				var modal_container_id = renderModal(local_entity, container);
				
				// показываем модалку
				showModal(modal_container_id);
			}
		},
		error: function(xhr, ajaxOptions, thrownError) {
			console.log(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
			handleAjaxError({
				messages: [{
					title: 'Ошибка обмена данными',
					msg: 'Ошибка обработки запроса на стороне сервера. Обратитесь в службу поддержки',
				}],
			});
		}
	});
}*/
//--></script>
			
			<div class="row text-center">
				<div class="col-lg-12">
					<hr>
					<a href="/">Расходы города</a> &copy; 2016. Все права защищены.<br />Версия 0.2
				</div>
			</div>
		</div>
    		<!-- jquery: везде -->
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-json/2.6.0/jquery.json.min.js"></script>
		<script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mouse0270-bootstrap-notify/3.1.5/bootstrap-notify.min.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsrender/0.9.82/jsrender.min.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/js-sha1/0.3.0/sha1.min.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/i18n/ru.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/1000hz-bootstrap-validator/0.11.5/validator.min.js"></script>
		
		<script src="http://vhost.dlinkddns.com:81/public/common.js"></script>
		<!-- для работы с модальными окнами  -->
		<script type="text/javascript" src="http://vhost.dlinkddns.com:81/public/modal.js"></script>
		<script type="text/javascript" src="http://vhost.dlinkddns.com:82/public/common-client.js"></script>
		<script src="http://vhost.dlinkddns.com:81/public/templates/common_templates.js"></script>
		<script src="http://vhost.dlinkddns.com:81/public/templates/scroller.js"></script>
		<script src="http://vhost.dlinkddns.com:81/public/templates/entity.js"></script>
		<script id="entity_template" type="text/x-jsrender">
<span></span>
<!--<br>templates\form_template-->
<div class="container-fluid" id="{{:descriptor.local_data.container_id}}"><!---->
	<div class="row">
		<div class="pull-right">
			{{if !~inModal}}
				{{if descriptor.operations ~descriptor=descriptor}}
					{{for descriptor.operations tmpl="operation" /}}
				{{/if}}
				<button type="button" class="btn btn-default" data-dismiss="modal" onclick="hideModal('{{:descriptor.local_data.container_id}}');">Отмена</button>
			{{/if}}
			<div>&nbsp;</div>
		</div><!-- /.pull-right -->
	</div><!-- /.row -->
	<div class="row">
		<div class="form-horizontal">
			{{if descriptor.fields ~fields=~utilities.objectToArray(descriptor.fields) ~descriptor=descriptor}}
				{{for ~fields}}
					<div class="form-group" name="field_{{:id}}">
						<label for="field_{{:id}}_value" class="col-sm-2 control-label">{{:name}}</label>
						<div class="col-sm-8">
							{{if type == "label"}}
								{{include tmpl = ~descriptor.actionName + "_entity_field_label" /}}
							{{else type == "text"}}
								{{include tmpl = ~descriptor.actionName + "_entity_field_text" /}}
							{{else type == "textarea"}}
								{{include tmpl = ~descriptor.actionName + "_entity_field_textarea" /}}
							{{else type == "select"}}
								{{include tmpl = ~descriptor.actionName + "_entity_field_select" /}}
							{{else type == "email"}}
								{{include tmpl = ~descriptor.actionName + "_entity_field_text" /}}
							{{else type == "amount"}}
								{{include tmpl = ~descriptor.actionName + "_entity_field_amount" /}}
							{{else type == "date"}}
								{{include tmpl = ~descriptor.actionName + "_entity_field_text" /}}
							{{else type == "period"}}
								{{include tmpl = ~descriptor.actionName + "_entity_field_period" /}}
							{{else type == "password"}}
								{{include tmpl = ~descriptor.actionName + "_entity_field_password" /}}
							{{else type == "bool"}}
								{{include tmpl = ~descriptor.actionName + "_entity_field_bool" /}}
							{{else type == "link"}}
								{{include tmpl = ~descriptor.actionName + "_entity_field_link" /}}
							{{else type == "img"}}
								{{include tmpl = ~descriptor.actionName + "_entity_field_img" /}}
							{{/if}}
						</div>
					</div>
				{{/for}}
			{{/if}}
		</div><!-- /.form-horizontal -->
		{{if descriptor.scrollers ~scrollers=~utilities.objectToArray(descriptor.scrollers)}}
			{{for ~scrollers }}
				<div class="row-fluid">
					<div id="placeholder_{{:#data.local_data.container_id}}"></div>
				</div><!-- /.row -->
				<!--<p>placeholder_{{:type}}_{{:controllerName}}_{{:udid}}</p>-->
			{{/for}}
		{{/if}}
	</div><!-- /.row -->
</div><!-- /.container-fluid -->
</script>

<script type="text/javascript"><!--

/* Cохраняет данные сущности на сервер из локальных данных. Если вызванв из интерфейса, то предварительно сохраняет формы локально
* @container_id - идентификатор контейнера сущности (располагается либо на отдельной странице, либо в модалке), передается при вызове из интерфейса
* @item - сущность, которую надо сохранить, передается при вызове из кода для сохранения на сервер
*/
function entitySave(container_id, item) {
	// описатель сохраняемой сущности
	var descriptor;
	// если вызвана из интерфейса, то сохраняем
	if(container_id) {
		descriptor = containers[container_id].data;
		// сохраняем данные формы локально
		if(!entitySaveToLocalFromHTML(container_id)) return;
	}
	else descriptor = item;
	
	// сохраняем на сервер новые записи в скроллерах с типом связи 'n', т.к. они еще не имеют нормального id, также у них нет container_id (т.к. они не отображаются отдельно), поэтому используется метод
	var deferreds = [];
	if(descriptor.scrollers) {
		for (var key in descriptor.scrollers) {
			var scroller = descriptor.scrollers[key];
			if(scroller.relationType == 'n' )	{
				// сохраняем добавленные сущности
				if(scroller.local_data.added_items) {
					var len = scroller.local_data.added_items.length;
					for (var i = 0; i<len; i++) {
						deferreds.push(entitySave(null, scroller.local_data.added_items[i]));
					}
				}
				// сохраняем измененные сущности
				var len = scroller.items.length;
				for (var i = 0; i<len; i++) {
					if(scroller.items[i].local_data.status == 'edited') deferreds.push(entitySave(null, scroller.items[i]));
				}
			}
		}
	}
	
	// привязываем сохранение на сервер сразу после сохранения сущностей дочерних скроллеров
	var res = $.when.apply($, deferreds);
	
	var def = $.Deferred();
	res.done(function() {
		var asd;
		// текущую сущность сохраняем на сервер, если она не открыта на редактирование или не 
		if((!descriptor.local_data.relationType || descriptor.local_data.relationType != 'n' || !container_id) && descriptor.local_data.status == 'edited') {
			asd = $.when(entitySaveToServer(descriptor)).done(function() {
				def.resolve();
			});
		}
		else {
			def.resolve();
		}
	});
	def.done(function() {
		// если сущность открывалась на редактирование для другого контейнера, то надо его обновить и закрыть модалку
		if(descriptor.local_data.target_container_id) {
			//var container = containers[descriptor.local_data.container_id];
			// перерисовываем скроллер
			var tContainerData = containers[descriptor.local_data.target_container_id].data;
			
			// добавляем сущность в скроллер
			var opts = {
				confirmFromServer: ((descriptor.local_data.relationType && descriptor.local_data.relationType == 'n') || !container_id) ? false : true,
			}
			if(tContainerData.type == 'scroller') addItemToScroller(descriptor, tContainerData, opts);
			
			// перерисовываем грид/скроллер
			renderScroller(tContainerData, false);
			
			hideModal(containers[container_id].parent_container_id);
		}
	});
	
	
	// если сохраняем из визуалки, то надо уведомить пользователя, что сохранение успешно
	/*if(container_id) def.done(function(){
		
	});*/
	
	return def;
}

/* Удаляет сущность с сервера. Вызывается из страницы скроллера или состраницы редактирования сущности
* @container_id - идентификатор контейнера скроллера или сущности (располагается либо на отдельной странице, либо в модалке)
* @id - ID сущности, которую надо удалить, передается при вызове из кода для удаления на сервере
*/
function entityDelete(container_id, id) {
	var scroller;
	var entity;
	// родительский контейнер: скроллер/грид, с элементом которого работаем, или сущность
	var container = containers[container_id];
	// описатель сущности, которую надо удалить
	var entity = entities[container.data.entity][id];
	
	var def = $.Deferred();
	if(entity.fields.id.value==-1) {
		delete entities[container.data.entity][id];
		def.resolve();
	}
	else {
		confirmDelete(container, id).done(function (){ 
			$.ajax({
				url: '/' + entity.entity + '/delete?id=' + id,
				dataType: 'json',
				method: 'get',
				beforeSend: function() {
						// показываем прогрессбар
				},
				complete: function() {
					// скрываем прогрессбар
				},			
				success: function(json) {
					if(!handleAjaxError(json.error)) {
						// удаляем локальную сущность
						//entity.local_data.status = 'deleted';
						//deleteItemFromScroller(scroller);
						
						handleAjaxSuccess(json.success)
						//console.log("С сервера получены полные данные сущности скроллера:");
						console.log(json);
						
						// TODO. Уведомить открытые скролеры и сущности, что сущность удалена
						// если удаляем запись скроллера
						if(container.data.type == 'scroller') {
							//deleteItemFromScroller(entity, container.data, {confirmFromServer:true});
							
							// перерисовываем скроллер
							//renderScroller(container.data);
							def.resolve();
						}
						// если удаляем сущность
						else {
							def.resolve();
							// закрываем модалку или переходим к скроллеру сущностей
							if(container.parent_container_id) {
								//var parent_container = containers[container.parent_container_id)
								hideModal(container.parent_container_id);
								
							}
							else if(json.redirectURL) {
								setTimeout(function(){
									document.location = json.redirectURL;
								}, 1000);
							}
						}
					}
					else def.reject();
				},
				error: function(xhr, ajaxOptions, thrownError) {
					console.log(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
					handleAjaxError({
						messages: [{
							title: 'Ошибка обмена данными',
							msg: 'Ошибка обработки запроса на стороне сервера. Обратитесь в службу поддержки',
						}],
					});
					def.reject();
				}
			});  
		});
	}
	return def;
}

/* Cохраняет данные формы локально
* @container_id - идентификатор контейнера сущности
*/
function entitySaveToLocalFromHTML(container_id) {
	// описатель сущности, которую надо сохранить
	var descriptor = containers[container_id].data;
	// объект jquery контейнера сущности, которую надо сохранить
	var jqobj = containers[container_id].jqobj;
	
	// собираем поля формы по идентификаторам в локальной сущности
	if(descriptor.fields) {
		var field, field_jqobj, val, val_id;
		var tmpFields = {};
		var error={messages:[],};
		var errorMsg = '';
		
		for(field_id in descriptor.fields) {
			val = null, val1 = null, val2 = null;
			val_id = null;
			field = descriptor.fields[field_id];
			
			// все, кроме статичного текста, можно сохранять
			if(field.type != 'label') {
				if(field.id != "operations") {
					if(field.type=='text' || field.type=='textarea' || field.type=='number' || field.type=='email' || field.type=='password' || field.type=='date' || field.type=='amount') {
						field_jqobj = jqobj.find("#field_"+field.id+"_value");
						if(field_jqobj.length>0) val = field_jqobj.val();
						else val = "";
						if(field.type=='password') val = sha1(val);
					}
					else if(field.type=='period') {
						field_jqobj1 = jqobj.find("#field_"+field.id+"_value1");
						field_jqobj2 = jqobj.find("#field_"+field.id+"_value2");
						if(field_jqobj1.length>0) val1 = field_jqobj1.val();
						else val1 = "";
						if(field_jqobj2.length>0) val2 = field_jqobj2.val();
						else val2 = "";
					}
					else if(field.type=='select') {
						field_jqobj = jqobj.find("#field_"+field.id+"_value");
						if(field_jqobj.val()) {
							val = field_jqobj.find("option:selected").text();
							val_id = field_jqobj.val();
						}
						else {
							val = "";
							val_id = "";
						}
					}
					else if(field.type=='link') {
						//значение сохраняется в сущность при закрытии моделки со скроллером
						val = field.value;
						val_id = field.value_id;
						/*field_jqobj = jqobj.find("#field_"+field.id+"_value");
						if(field_jqobj.length>0) val = field_jqobj.val();
						else val = "";*/
					}
					
					// проверка на обязательность не зависимо от типа
					if(field.required && field.required != "undefined" && (val == null || val == '' || val == 'undefined' || (val == null && val1 == null && val2 == null)) && val_id != "*") {
					}
					// выполняем остальные проверки
					else {
						if(field.type == 'amount' && val != null && val != '' && val != 'undefined') {
							if((val != null && val.length>0) || val == "") {
								if(/^\d{1,15}.?\d{0,2}$/.test(val)==null) {
									errorMsg += '<li>Поле "' + field.name + '" содержит значение, не соответствующее формату десятичного числа</li>';
								}
								else {
									realVal = null;
									var pos = val.indexOf('.');
									var cents;
									if(pos>=0) cents = val.replace(".", '');
									else cents = val + "00";
									realVal = parseInt(cents, 10);
									if(realVal != null && field.min && realVal < field.min) {
										errorMsg += '<li>Поле "' + field.name + '" содержит значение меньше допустимого</li>';
									}
									if(realVal != null && field.max && realVal > field.max) {
										errorMsg += '<li>Поле "' + field.name + '" содержит значение больше допустимого</li>';
									}
								}
							}
						}
						else if(field.type == 'email' && val != null && val != '' && val != 'undefined') {
							if(val.indexOf('@') == -1) {
								errorMsg += '<li>Поле "' + field.name + '" содержит значение, не соответствущее адресу электронной почты</li>';
							}
						}
						else if((field.type == 'period') && val1 != null && val1 != '' && val1 != 'undefined' && val2 != null && val2 != '' && val2 != 'undefined') {
							// TODO. Проверять, чтобы дата from не была больше даты to
						}
						else if((field.type == 'text' || val == 'textarea') && val != null && val != '' && val != 'undefined') {
							if(field.min && val.length < field.min) {
								errorMsg += '<li>Поле "' + field.name + '" содержит слишком короткое значение (должно быть не менее ' + field.min + ' символов)</li>';
							}
							if(field.max && val.length > field.max) {
								errorMsg += '<li>Поле "' + field.name + '" содержит слишком длинное значение (должно быть не более ' + field.max + ' символов)</li>';
							}
						}
					}
					if(errorMsg.length==0) { 
						if(val != null && val != "undefined") tmpFields[field.id] = {value: val};
						if((val1 != null && val1 != "undefined") || (val2 != null && val2 != "undefined")) {
							tmpFields[field.id] = {};
							if(val1 != null && val1 != "undefined") tmpFields[field.id].value1 = val1;
							if(val2 != null && val2 != "undefined") tmpFields[field.id].value2 = val2;
						}
						if(val_id != null && val_id != "undefined") tmpFields[field.id].value_id = val_id;
					}
				}
			}
		}
		if(errorMsg.length>0) { 
			handleAjaxError({messages:[{
				title: "Ошибки в заполнении полей",
				msg: '<ul>' + errorMsg + '</ul>',
			}]}); 
			return null; 
		}
		else {
			// переносим значения в локальную сущность
			for(tmpID in tmpFields) {
				tmpField = tmpFields[tmpID];
				if(tmpField.value) descriptor.fields[tmpID].value = tmpField.value;//encodeURIComponent(tmpField.value);
				if(tmpField.value1) descriptor.fields[tmpID].value1 = tmpField.value1;//encodeURIComponent(tmpField.value);
				if(tmpField.value2) descriptor.fields[tmpID].value2 = tmpField.value2;//encodeURIComponent(tmpField.value);
				if(tmpField.value_id)descriptor.fields[tmpID].value_id = tmpField.value_id;//encodeURIComponent(tmpField.value_id);
				//field.value = val;
				//if(val_id != "undefined") field.value_id = val_id;
			}
		}
		
		// обрабатка скроллеров не выполняется, т.к. сущности в скроллере уже в группе "added_items", а сами сущности в состоянии "edited".
		// помечаем сущность, как измененную локально
		if(descriptor.local_data.status == 'actual') descriptor.local_data.status = "edited";
		
		// TODO. Сообщить остальным контейнерам, что сущность обновлена, а в текущем контейнере убрать такое уведомление, т.к. сущность актуальна
		
		return descriptor;
	}
}


/* Cохраняет данные сущности на сервер и возвращает Deffered
* @descriptor - описатель сущности, которую надо сохранить
*/
function entitySaveToServer(descriptor){
	var def = $.Deferred();
	var container = containers[descriptor.local_data.container_id];
	
	// сохраняем сущность на сервер
	var clearFields = {};
	for (var key in descriptor.fields) {
		clearFields[key] = {
			id: descriptor.fields[key]['id'],
			value: descriptor.fields[key]['value'],
			value1: descriptor.fields[key]['value1'],
			value2: descriptor.fields[key]['value2'],
			value_id: descriptor.fields[key]['value_id'],
		};
	}
	
	var data = {
		//fields: descriptor.fields
		fields: clearFields,
	}
	
	// готовим записи скроллеров
	if(descriptor.scrollers) {
		data.scrollers = {};
		for (var key in descriptor.scrollers) {
			var scroller = descriptor.scrollers[key];
			data.scrollers[key] = {};
			// сохраняем добавленные сущности
			if(scroller.local_data.added_items) {
				data.scrollers[key].added_items = [];
				var len = scroller.local_data.added_items.length;
				for (var i = 0; i<len; i++) {
					data.scrollers[key].added_items.push(scroller.local_data.added_items[i].fields.id.value);
				}
			}
			// удаляем удаленные сущности
			if(scroller.local_data.deleted_items) {
				data.scrollers[key].deleted_items = [];
				var len = scroller.local_data.deleted_items.length;
				for (var i = 0; i<len; i++) data.scrollers[key].deleted_items.push(scroller.local_data.deleted_items[i].fields.id.value);
			}
		}
	}
	
	$.ajax({
		url: '/' + descriptor.entity + '/save?id=' + descriptor.fields.id.value,
		dataType: 'json',
		data:  $.toJSON(data),
		method: 'post',
		beforeSend: function() {
			// показываем прогрессбар
		},
		complete: function() {
			// скрываем прогрессбар
		},			
		success: function(json) {
			//console.log("Сущность сохранена на сервер");
			console.log(json);
			if(!descriptor.local_data.relationType || descriptor.local_data.relationType != 'n') handleAjaxSuccess(json.success);
			// если нет ошибок
			if(!handleAjaxError(json.error)) {
				if(json.newID) {
					descriptor.fields.id.value = json.newID;
					entities[descriptor.entity][json.newID] = entities[descriptor.entity][descriptor.local_data.eid];
					delete entities[descriptor.entity][descriptor.local_data.eid];
					descriptor.local_data.eid = json.newID;
				}
				descriptor.local_data.status = 'actual';
				
				// очищаем локальные списки добавленных/удаленных элементов
				if(descriptor.scrollers) {
					for(var key in descriptor.scrollers) {
						var scroller = descriptor.scrollers[key];
						if(scroller.local_data.added_items) {
							var len = scroller.local_data.added_items.length;
							for (var i = len-1; i>=0; i--) {
								scroller.items.unshift(scroller.local_data.added_items[i]);
							}
							delete scroller.local_data.added_items;
						}
						var len = scroller.items.length;
						for (var i = 0; i<len; i++) {
							scroller.items[i].local_data.status = 'actual';
						}
						delete scroller.local_data.deleted_items;
						
						// и перерисовываем скроллеры
						renderScroller(scroller, false);
					}
				}
				
				def.resolve({descriptor: descriptor, container: container});
			}
			else def.reject();
		},
		error: function(xhr, ajaxOptions, thrownError) {
			console.log(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
			handleAjaxError({
				messages: [{
					title: 'Ошибка обмена данными',
					msg: 'Ошибка обработки запроса на стороне сервера. Обратитесь в службу поддержки',
				}],
			});
			def.reject();
		}
	});
	
	// если сохранение данных на сервер успешно, то сохраняем файлы
	var filesDef = $.Deferred();
	def.done(function(data) {
		var container = data.container;
		var descriptor = data.descriptor;
		
		// загружаем и удаляем файлы
		var deferreds = [];
		for(var key in descriptor.fields) {
			var field = descriptor.fields[key];
			if(field.type == 'img') {
				// создаем отложенное уведомление о завершении загрузки
				var deferredUpload = $.Deferred();
				var deferredDelete = $.Deferred();
				// помещаем уведомление в сущность, чтобы вызвать из событий загрузки файла
				descriptor.local_data.fields[key].deferredUpload = deferredUpload;
				descriptor.local_data.fields[key].deferredDelete = deferredDelete;
				// после загрузки всех файлов одного поля сущности запускаем отложенное удаление файлов
				deferredUpload.done(function(){
					deleteEntityFiles(descriptor, key);
				});
				// помещаем в общий массив полей сущности с файлами
				deferreds.push(deferredUpload);
				deferreds.push(deferredDelete);
				
				descriptor.local_data.fields[key].settings.uploadExtraData.parent_entity_id = descriptor.local_data.eid;
				descriptor.local_data.fields[key].inputJQ.fileinput('refresh',descriptor.local_data.fields[key].settings).fileinput('upload');
				//descriptor.local_data.fields[key].inputJQ.fileinput('upload');
				//$("input[type='file'][id='field_" + field.id + "']").fileinput('upload');
			}
		}
		$.when.apply($, deferreds).done(function(){
			// загрузка и удаление файлов выполнены
			filesDef.resolve();
		});
		// если загрузка файлов не требуется, то обновляем целевой скроллер здесь
		if(deferreds.length==0) {
			descriptor.local_data.status = 'actual';
		
			if(descriptor.local_data.target_container_id) {
				//var container = containers[descriptor.local_data.container_id];
				// перерисовываем скроллер
				var tContainerData = containers[descriptor.local_data.target_container_id].data;
				
				// добавляем сущность в скроллер
				if(tContainerData.type == 'scroller') addItemToScroller(descriptor, tContainerData, {confirmFromServer:true});
				
				// перерисовываем грид/скроллер
				renderScroller(tContainerData, false);
				
				if(container) hideModal(container.parent_container_id);
			}
			filesDef.resolve();
		}
	});
    
	return filesDef;
}

/* Удаляет файл из поля после успешной загрузки
* @descriptor - описатель сущности
* @fieldName - наименование поля сущности, для которого выполняется удаление
*/
function deleteEntityFiles(descriptor, fieldName) {
	var dfiles;
	if(!descriptor.local_data.fields || !descriptor.local_data.fields[fieldName] || !descriptor.local_data.fields[fieldName].deletedFiles || descriptor.local_data.fields[fieldName].deletedFiles.length==0) {
		if(descriptor.local_data.fields[fieldName].deferredDelete) descriptor.local_data.fields[fieldName].deferredDelete.resolve();
		return;
	}
	dfiles = descriptor.local_data.fields[fieldName].deletedFiles;
	
	//var deferreds = [];
	
	//var dfilesLength = dfiles.length;
	var data = {
		files: dfiles,
		parent_entity_id: descriptor.local_data.eid,
		parent_entity_name: descriptor.entity,
		parent_entity_field: fieldName,
	}

	//for(var i=0; i < dfilesLength; i++) {
		//var dfile = dfiles[i];
	$.when($.ajax({
		url: '/file/delete',
		dataType: 'json',
		data:  data,//$.toJSON(data),
		method: 'post',
		beforeSend: function() {
			// показываем прогрессбар
		},
		complete: function() {
			// скрываем прогрессбар
		},			
		success: function(json) {
			//console.log("Сущность сохранена на сервер");
			console.log(json);
			handleAjaxSuccess(json.success);
			// если нет ошибок
			if(!handleAjaxError(json.error)) {
				delete descriptor.local_data.fields[fieldName].deletedFiles;
				
			}
		},
		error: function(xhr, ajaxOptions, thrownError) {
			console.log(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
			handleAjaxError({
				messages: [{
					title: 'Ошибка обмена данными',
					msg: 'Ошибка обработки запроса на стороне сервера. Обратитесь в службу поддержки',
				}],
			});
		}
	})).done(function(){
		descriptor.local_data.fields[fieldName].deferredDelete.resolve();
	}).fail(function(){
		descriptor.local_data.fields[fieldName].deferredDelete.reject();
	});
	//}
}

//--></script>
<div id="container_modals"></div>

<script id="modal_template" type="text/x-jsrender">
<span></span>
<!--<br>templates\modal_template-->
<div class="modal" id="{{:modal_container_id}}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel_{{:modal_container_id}}" data-backdrop="static">
	<div class="modal-dialog modal-lg" {{if (descriptor.type=='scroller' || (descriptor.scrollers && ~utilities.getOjectKeysCount(descriptor.scrollers) > 0)) }}style="width: 95%" {{/if}} role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" id="myModalLabel_{{:descriptor.local_data.udid}}">{{:descriptor.title}}</h4>
			</div>
			<div class="modal-body">
				<div class="container-fluid">
					<div class="row">
						<div class="pull-right">
							{{if descriptor.type == "entity"}}
								{{if descriptor.operations ~descriptor=descriptor}}
									{{for descriptor.operations tmpl="operation" /}}
								{{/if}}
								<button type="button" class="btn btn-default" data-dismiss="modal" onclick="hideModal('{{:modal_container_id}}');">Отмена</button>
							{{else}}
								<button type="button" class="btn btn-primary" onclick="linkSelectedRows('{{:descriptor.local_data.container_id}}');">Выбрать</button>
								<button type="button" class="btn btn-default" data-dismiss="modal" onclick="hideModal('{{:modal_container_id}}');">Отмена</button>
							{{/if}}
							<div>&nbsp;</div>
						</div><!-- /.pull-right -->
					</div><!-- /.row -->
					<div class="row">
						{{include tmpl="#"+tmplName ~inModal=1/}}
					</div><!-- /.row -->
				</div><!-- /.container-fluid -->
			</div>
			<div class="modal-footer"></div>
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div><!-- /.modal -->
</script>

<script id="scroller_template" type="text/x-jsrender">
<span></span>
<div class="container-fluid">
	<div class="row">
		<div class="panel panel-default" id="{{:descriptor.local_data.container_id}}">
			<div class="panel-heading stat-scroller-header"{{if !(descriptor.notCollapsible == "1")}} data-toggle="collapse" data-target="#{{:descriptor.local_data.container_id}}CollapseDiv{{/if}}">
				{{:descriptor.title}}
				{{if !(descriptor.notCollapsible == "1")}}<span class="pull-right "><button type="button" class="btn btn-default btn-xs"><i class="glyphicon glyphicon-minus"></i></button></span>{{/if}}
			</div><!-- /.panel-heading -->
			<!--<div class="panel-body"> не используется с таблицей в panel-->
			{{if !(descriptor.notCollapsible == "1")}}<div id="{{:descriptor.local_data.container_id}}CollapseDiv" class="collapse in">{{/if}}<!---->
			<!--<div class="panel-body">-->
				<input hidden="" id="page" value="{{:descriptor.filter_values.page}}">
				<input hidden="" id="sort" value="{{:descriptor.filter_values.sort}}">
				<input hidden="" id="order" value="{{:descriptor.filter_values.order}}">
				<input hidden="" id="page_size" value="{{:descriptor.filter_values.page_size}}">
				
				{{if descriptor.columns ~columns=~utilities.objectToArray(descriptor.columns) ~descriptor=descriptor}}
				<div class="table-responsive"> 
					<table id="{{:descriptor.local_data.container_id}}" class="table table-striped table-bordered table-hover table-condensed">
						<thead>
							{{if descriptor.group_operations.length > 0 || descriptor.common_operations > 0 ~descriptor=descriptor}}
								<!-- строка общих операций -->
								<tr>
									<td colspan="{{:~columns.length+2}}">
										<div class="pull-right" role="group" aria-label="...">&nbsp;
											{{for descriptor.common_operations tmpl="common_operation" /}}
										
											{{for descriptor.group_operations}}
												<div class="btn-group"><button type="button" class="btn btn-xs dropdown-toggle" data-toggle="dropdown">С выбранными<span class="caret"></span></button><ul class="dropdown-menu">{{include tmpl="button_group_delete"/}}</ul></div>
											{{/for}}
										</div><!-- /.btn-group -->
									</td>
								</tr>
							{{/if}}
							<!-- строка заголовков -->
							<tr>
								{{if descriptor.group_operations.length > 0}}<th>{{if ~descriptor.local_data.select_style == "radio"}}{{else}}<input type="checkbox" name="{{:~descriptor.local_data.container_id}}" class="toggle-all"/>{{/if}}</th>{{/if}}
								{{for ~columns}}
									<th{{if hideble}} class="hidden-xs hidden-sm hidden-md"{{/if}}>
										{{if sortable}}
											<span onclick="change_sort('{{:~descriptor.local_data.container_id}}', '{{:id}}');"><u>{{:name}}</u></span>
											{{if id === ~descriptor.filter_values.sort}}
												<button type="button" class="btn btn-default btn-xs" aria-label="{{:name}}" name="{{:id}}" onclick="change_sort('{{:~descriptor.local_data.container_id}}', '{{:id}}');">
												{{if ~descriptor.filter_values.order === "DESC"}}
													<span class="glyphicon glyphicon-sort-by-attributes-alt" aria-hidden="true"></span>
												{{else}}
													<span class="glyphicon glyphicon-sort-by-attributes" aria-hidden="true"></span>
												{{/if}}
												</button>
											{{/if}}
										{{else}}
											{{:name}}
										{{/if}}
									</th>
								{{/for}}
							</tr>
						</thead>
						<tbody>
							{{if descriptor.filter_operations && descriptor.filter_operations.length>0}}
								<!-- строка фильтров -->
								<tr>
									{{if descriptor.group_operations.length > 0}}<td class="stat-row-checkbox-td"></td>{{/if}}
									{{for ~columns}}
										<td class="{{if hideble}}hidden-xs hidden-sm hidden-md {{/if}}{{if id == "id"}}stat-id-td{{else id == "active"}}stat-active-td{{else id == "operations"}}stat-operations-td{{/if}}">
											{{if filter}} 
												{{if filter==="text"}} <input type="text" name="filter_{{:id}}" value="{{:filter_value}}" class="form-control input-sm"/>
												{{else filter==="number"}} <input type="number" name="filter_{{:id}}" value="{{:filter_value}}"{{if id == "id"}} class="form-control input-sm stat-id-input-field"{{/if}} min="0"/>
												{{else filter==="email"}} <input type="email" name="filter_{{:id}}" value="{{:filter_value}}" class="form-control input-sm"/>
												{{else filter==="select"}}
													{{if filter_values.length>10}}<div class="input-group-sm">{{/if}}
														<select name="filter_{{if filter_id }}{{:filter_id}}{{else}}{{:id}}{{/if}}" class="form-control input-sm {{if filter_values.length>2}}extended{{/if}}" style="width:100%;">
															<option value="*" {{if filter_value===""}} selected="selected"{{/if}}></option>
															{{if nullSubstitute && nullSubstitute != "undefined"}}<option value="**" {{if filter_value=='**'}} selected="selected"{{/if}}>{{:nullSubstitute}}</option>{{/if}}
															{{if style === "id"}}
																{{for filter_values ~filter_value=filter_value}}<option value="{{:id}}" {{if id==~filter_value}}selected="selected"{{/if}}>{{:name}}</option>{{/for}}
															{{else }}
																{{for filter_values ~filter_value=filter_value}}<option value="{{:#data}}" {{if #data==~filter_value}}selected="selected"{{/if}}>{{:#data}}</option>{{/for}}
															{{/if}}
														</select>
													{{if filter_values.length>2}}</div>{{/if}}
												{{else filter==="bool"}}
													<select name="filter_{{:id}}" class="form-control input-sm">
														<option value="*" {{if filter_value == "*" || filter_value == ""}} selected="selected"{{/if}}></option>
														<option value="1" {{if filter_value == "1"}} selected="selected"{{/if}}>Да</option>
														<option value="0" {{if filter_value == "0"}} selected="selected"{{/if}}>Нет</option>
													</select>
												{{/if}}
											{{else id==="operations"}}
												{{for ~descriptor.filter_operations tmpl="filter_operation" /}}
											{{/if}}
										</td>
									{{/for}}
								</tr>
							{{/if}}
							
							<!-- строки с данными -->
							<!-- добавленные строки -->
							{{if ~descriptor.local_data.added_items && ~descriptor.local_data.added_items.length>0  }}
								{{for ~descriptor.local_data.added_items}}
									<tr class="odd gradeX success{{if ~descriptor.local_data.status=='actual' && fields.id.value != -1}} status-actual{{/if}} {{:fields.id.value}}">
										{{include tmpl=~descriptor.controllerName+"_row" /}}
									</tr>
								{{/for}}
							{{/if}}	
							<!-- удаленные строки -->
							{{if ~descriptor.local_data.deleted_items && ~descriptor.local_data.deleted_items.length>0  }}
								{{for ~descriptor.local_data.deleted_items }}
									<tr class="odd gradeX danger">
										{{include tmpl=~descriptor.controllerName+"_row" /}}
									</tr>
								{{/for}}
							{{/if}}	
							<!-- стандартные строки -->
							{{if ~descriptor.items && ~descriptor.items.length>0 }}
								{{for ~descriptor.items }}
									<tr class="odd gradeX {{if local_data.status=='edited'}}warning{{/if}}">
										{{include tmpl=~descriptor.controllerName+"_row" /}}
									</tr>
								{{/for}}
							{{else (!~descriptor.local_data.added_items || ~descriptor.local_data.added_items.length==0) && (!~descriptor.local_data.deleted_items || ~descriptor.local_data.deleted_items.length==0) }}	
								<!-- если данных нет -->
								<tr ><td colspan="{{if descriptor.group_operations.length > 0}}{{:~columns.length+2}}{{else}}{{:~columns.length+1}}{{/if}}"><p class="text-center">Нет данных для отображения</p></td></tr>
							{{/if}}
						</tbody>
					</table>
					</div>
				{{/if}}
				<!--</div> /.panel-body -->
				<div class="panel-footer">
					<!-- записей на странице -->
					<span class="pull-right">Показывать по&nbsp;{{include tmpl="page_size" ~descriptor=descriptor /}}</span>
					{{for descriptor.pager ~descriptor=descriptor }}
						<nav>
							<ul class="pagination stat-pager">
								{{if ~descriptor.filter_values.page>1}}
									<li onClick="change_page('{{:~descriptor.local_data.container_id}}', {{:~descriptor.filter_values.page}}-1);"><a href="#" aria-label="pager_prev"><span aria-hidden="true">&laquo;</span></a></li>
								{{else}}
									<li class="disabled"><span aria-label="Previous"><span aria-hidden="true">&laquo;</span></span></li>
								{{/if}}
								<!-- выводим номера страниц -->
								{{:~utilities.getPagerHtml(~descriptor)}}
								{{if ~descriptor.filter_values.page<~descriptor.pager.total_pages}}
									<li onClick="change_page('{{:~descriptor.local_data.container_id}}', {{:~descriptor.filter_values.page}}+1);"><a href="#" aria-label="pager_next"><span aria-hidden="true">&raquo;</span></a></li>
								{{else}}
									<li class="disabled"><span aria-label="Next"><span aria-hidden="true">&raquo;</span></span></li>
								{{/if}}
							</ul>
						</nav>
					{{/for}}
				</div>
			{{if !(descriptor.notCollapsible == "1")}}</div>{{/if}} <!--/#{{:descriptor.local_data.container_id}}CollapseDiv -->
		</div><!-- /.panel -->
	</div><!-- /.row -->
</div><!-- /.container-fluid -->
</script>

<script type="text/javascript"><!--


function initScrollerScripts(container_id) {
	var container = containers[container_id];
	// если у скроллера есть общий чекбокс для всех, то настраиваем его переключение
	var toggleAll = container.jqobj.find("input.toggle-all:not(:has(.inited))");
	toggleAll.on('change', function() {
		//alert(containers[container_id].jqobj.find("tbody tr input[name^='row_scroller']").length);
		containers[container_id].jqobj.find("input[name^='row_scroller']").each(function(indx, element){
			$(this).prop("checked", $("#" + container_id + " input.toggle-all[name='" + container_id + "']").prop('checked'));
		});
	});
	toggleAll.addClass("inited");
	
	// если скроллер сворачиваемый, то добавляем смену индикатора развернутости в заголовке скроллера
	container.jqobj.find(".panel-heading[data-toggle='collapse']").each(function(indx, element) {
		$(this).on('click', function(e) {
			var icon = $(this).find('i');
			if(icon.hasClass('glyphicon-minus')) icon.removeClass('glyphicon-minus').addClass('glyphicon-plus');
			else icon.removeClass('glyphicon-plus').addClass('glyphicon-minus');
		});
	});
	
	// если скроллер открыт на странице, то инициализируем кнопки удаления, с вопросом о подтверждении
	/*if(!container.parent_container_id) {
		container.jqobj.find("button[data-toggle='popover']").each(function(indx, element) {
			var btn = $(this);
			// определяем, является ли это кнопка удаления
			var rb = btn.find('span.glyphicon-remove');
			if(rb.length == 1) {
				var options = {
					placement: 'top',
					title: 'Вы уверены, что хотите удалить запись?',
					content: function() {
						var html = '<button type="button" class="btn btn-xs" aria-label="Да" name="yes" onclick="">Да</button><button type="button" class="btn btn-xs" aria-label="Нет" name="no" onclick="">Нет</button>';
						return html;
					},
				}
				var pp = btn.popover(options);
				pp.find('div.popover-content').each(function(indx, element) {
					($this).html('<button type="button" class="btn btn-xs" aria-label="Да" name="yes" onclick="">Да</button><button type="button" class="btn btn-xs" aria-label="Нет" name="no" onclick="">Нет</button>');
				});
			}
			btn.on('click', function() {$(this).popover('show');});
		});
	}*/
	
	// для полей input строки фильтра добавляем применение фильтрации по Enter
	container.jqobj.find("input[name^='filter_']:not(:has(.inited))").each(function(indx, element) {
		$(this).focusin(function(){
			$(this).bind('keypress', function(e) {
				if(e.keyCode==13){
					apply_filter(container_id);
				}
			});
		}).focusout(function(){
			$(this).unbind('keypress', false);
		}).addClass("inited");
	});
	
	// если есть строки в добавленных, которые добавлены с сохранением на сервер, то анимируем изменение цвета статуса success
	container.jqobj.find("tr.status-actual").each(function(indx, element) {
		var obj = $(this);
		setTimeout(function(){
            obj.removeClass('status-actual success');
		}, 2000);  
	});
	
	// улучшаем выпадающие списки
	if ($.fn.select2) {
		$.fn.select2.defaults.set( "theme", "bootstrap");
		$("select.extended").select2();
	}
}

/* Переход к просмотру строки
* @container_id - идентифкатор контейнера (скроллера), запись которого необходимо открыть на просмотр
* @id - id (eid) просматриваемой сущности (null, если создается новая сущность)
*/
function row_show(container_id, id) {
	// родительский контейнер (скроллер), элемент которого открываем
	var container = containers[container_id];
	var scroller = container.data;
	url = '/'+scroller.entity + '/show' + (id ? '?id=' + id : '');
	
	if(scroller.edit_style=="url") {
		//console.log("row_edit_entity=" + url);
		document.location = url;
	}
	else if(scroller.edit_style=="modal") {
		// если сущность открыта в другой модалке или на родительской форме, то сообщаем об этом
		if(entities[scroller.entity] && entities[scroller.entity][id]) {
			if(containers[entities[scroller.entity][id].local_data.container_id]) {
				// TODO. такие уведомлялки делать в виде Popup на кнопке, исчезающего через несколько секунд
				alert("Сущность уже открыта на редактирование в другой экранной форме. Завершите работу с диалогами и вернитесь к редактированию сущности");
				return;
			}
			// если сущность не сохранена на сервере или сущность сохранена на сервере, но она отредактирована / удалена локально
			if(entities[scroller.entity][id].fields.id.value == -1 || (entities[scroller.entity][id].fields.id.value != -1 && entities[scroller.entity][id].local_data.status != 'actual')) {
				// рисуем модалку
				var modal_container_id = renderModal(entities[scroller.entity][id], container);
				
				// показываем модалку
				showModal(modal_container_id);
				return;
			}
		}
		
		// запрашиваем с сервера более подробную информацию (всю сущность, а не только скроллерную запись)
		// при этом, если выполняется операция add, то будет запрошена информация пустой сущности
		$.ajax({
			url: url,
			dataType: 'json',
			method: 'get',
			beforeSend: function() {
					// показываем прогрессбар
			},
			complete: function() {
				// скрываем прогрессбар
			},			
			success: function(json) {
				if(!handleAjaxError(json.error)) {
					//console.log("С сервера получены полные данные сущности скроллера:");
					console.log(json);
					
					// сохраняем полученные данные
					var local_entity = saveFullServerEntity(json);
					//if(!id) local_entity.local_data.status = 'added';
					//local_entity.local_data.target_container_id = container.local_data.container_id;
					if(scroller.relationType) local_entity.local_data.relationType = scroller.relationType;
					
					// присваиваем идентификаторы скролерам, чтобы при выводе основных данных сущности оставить метки для их размещения
					initEntityScrollers(local_entity);
					
					// рисуем модалку
					var modal_container_id = renderModal(local_entity, container);
					
					// показываем модалку
					showModal(modal_container_id);
				}
			},
			error: function(xhr, ajaxOptions, thrownError) {
				console.log(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
				handleAjaxError({
					messages: [{
						title: 'Ошибка обмена данными',
						msg: 'Ошибка обработки запроса на стороне сервера. Обратитесь в службу поддержки',
					}],
				});
			}
		});
	}
	else {
		alert("Запрошен просмотр сущности с неизвестным scroller.edit_style");
	}
}

/* Переход к редактированию строки
* @container_id - идентифкатор контейнера (скроллера), запись которого необходимо открыть на редактирование
* @id - id (eid) редактируемой сущности (null, если создается новая сущность)
*/
function row_edit(container_id, id) {
	// родительский контейнер (скроллер), элемент которого открываем
	var container = containers[container_id];
	var scroller = container.data;
	url = '/'+scroller.entity + '/edit' + (id ? '?id=' + id : '');
	
	if(scroller.edit_style=="url") {
		//console.log("row_edit_entity=" + url);
		document.location = url;
	}
	else if(scroller.edit_style=="modal") {
		// если сущность открыта в другой модалке или на родительской форме, то сообщаем об этом
		if(entities[scroller.entity] && entities[scroller.entity][id]) {
			if(containers[entities[scroller.entity][id].local_data.container_id]) {
				// TODO. такие уведомлялки делать в виде Popup на кнопке, исчезающего через несколько секунд
				alert("Сущность уже открыта на редактирование в другой экранной форме. Завершите работу с диалогами и вернитесь к редактированию сущности");
				return;
			}
			// если сущность не сохранена на сервере или сущность сохранена на сервере, но она отредактирована / удалена локально
			if(entities[scroller.entity][id].fields.id.value == -1 || (entities[scroller.entity][id].fields.id.value != -1 && entities[scroller.entity][id].local_data.status != 'actual')) {
				// рисуем модалку
				var modal_container_id = renderModal(entities[scroller.entity][id], container);
				
				// показываем модалку
				showModal(modal_container_id);
				return;
			}
		}
		
		// запрашиваем с сервера более подробную информацию (всю сущность, а не только скроллерную запись)
		// при этом, если выполняется операция add, то будет запрошена информация пустой сущности
		$.ajax({
			url: url,
			dataType: 'json',
			method: 'get',
			beforeSend: function() {
					// показываем прогрессбар
			},
			complete: function() {
				// скрываем прогрессбар
			},			
			success: function(json) {
				if(!handleAjaxError(json.error)) {
					//console.log("С сервера получены полные данные сущности скроллера:");
					console.log(json);
					
					// сохраняем полученные данные
					var local_entity = saveFullServerEntity(json);
					//if(!id) local_entity.local_data.status = 'added';
					//local_entity.local_data.target_container_id = container.local_data.container_id;
					if(scroller.relationType) local_entity.local_data.relationType = scroller.relationType;
					
					// присваиваем идентификаторы скролерам, чтобы при выводе основных данных сущности оставить метки для их размещения
					initEntityScrollers(local_entity);
					
					// рисуем модалку
					var modal_container_id = renderModal(local_entity, container);
					
					// показываем модалку
					showModal(modal_container_id);
				}
			},
			error: function(xhr, ajaxOptions, thrownError) {
				console.log(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
				handleAjaxError({
					messages: [{
						title: 'Ошибка обмена данными',
						msg: 'Ошибка обработки запроса на стороне сервера. Обратитесь в службу поддержки',
					}],
				});
			}
		});
	}
	else {
		alert("Запрошено создание/редактирование сущности с неизвестным scroller.edit_style");
	}
}

/* Удаляет строку из скроллера/грида. Если скроллер отображается не в рамках сущности, то удаление строки выполняется с сервера
* @container_id - идентифкатор контейнера (скроллера), запись которого необходимо удалить
* @id - id удаляемой сущности
*/
function row_delete(container_id, id) {
	container = containers[container_id];
	// родительский скроллер/грид, с элементом которого работаем
	var scroller = containers[container_id].data;
	// описатель удаляемой сущности
	var entity = entities[scroller.entity][id];
	
	// удаляем с запросом, если этот скроллер открыт на отдельной странице или в ммодеальном окне,т.е. не предусмотрена кнопка "Сохранить" или "Применить"
	if((!container.parent_container_id)){// ||
		// отображается на форме сущности и отношение 'n' и сущность, т.е. сущности скроллера создаются только для текущей сущности
		//(container.parent_container_id && containers[container.parent_container_id].data.type == 'entity' && scroller.relationType == 'n')) {
		
		entityDelete(container_id, id).done(function (){
			deleteItemFromScroller(entity, scroller, {confirmFromServer:true});
			renderScroller(scroller);
		});
	}
	// помечаем удаленными в скроллере
	else {
		deleteItemFromScroller(entities[scroller.entity][id], scroller, {confirmFromServer:false})
		renderScroller(scroller);
	}
}

// Запрашивает и выводит отфильтрованные данные
function apply_filter(container_id) {
	var container = containers[container_id];
	var data = container.data;
	var udid = data.local_data.udid;
	var jqobj = container.jqobj;
	var rq = {};
	url = '/'+data.controllerName+'/filter';
	
	// собираем служебные поля фильтра скроллера
	var page = jqobj.find('#page').val();
	//url += 'page=' +  encodeURIComponent(page ? page : 1);
	rq.page = encodeURIComponent(page ? page : 1);
	
	var sort = jqobj.find('#sort').val();
	//if (sort) url += '&sort=' + encodeURIComponent(sort);
	if (sort) rq.sort = encodeURIComponent(sort);
	
	var order = jqobj.find('#order').val();
	//if (order) url += '&order=' + encodeURIComponent(order);
	if (order) rq.order = encodeURIComponent(order);
	
	var page_size = jqobj.find("select[name='page_sizes']").val();
	//if (page_size) url += '&page_size=' + encodeURIComponent(page_size);
	if (page_size) rq.page_size = encodeURIComponent(page_size);
	
	// пробегаемся по столбцам, чтобы собрать данные фильтров в столбцах данных
	var columns = jqobj.find("table tr:eq(2) td");
	var columns_length = columns.length;
	for(var i=0; i<columns_length; i++){
		var field = columns.eq(i).find("input[name^='filter_']").filter("[type='text'], [type='number'], [type='email']");
		if(field.val()) {//url += '&'+field.attr("name")+'=' + encodeURIComponent(field.val());
			rq[field.attr("name")] = encodeURIComponent(field.val());
			console.log('filter = ' + rq[field.attr("name")]);
		}
		else {
			field = columns.eq(i).find("select[name^='filter_']");
			if(field.val() && field.val() == "**") //url += '&'+field.attr("name")+'=' + encodeURIComponent(field.val());
				rq[field.attr("name")] = encodeURIComponent(field.val());
			else if(field.val() && field.val() != "*") //url += '&'+field.attr("name")+'=' + encodeURIComponent(field.val());
				rq[field.attr("name")] = encodeURIComponent(field.val());
			else {
				// TODO: checkbox и пр.
			}
		}
	}
	// доп. фильтры
	if(data.add_filter) {
		rq.add_filter = {};
		for (var key in data.add_filter) rq.add_filter[key] = data.add_filter[key];
	}
	
	console.log(url);
	$.ajax({
		url: url,
		data: rq,
		dataType: 'json',
		//dataType: 'html',
		method: 'post',
		beforeSend: function() {
				// показываем прогрессбар
		},
		complete: function() {
			// скрываем прогрессбар
		},			
		success: (function(json) {
			if(!handleAjaxError(json.error)) {
				// используется замкание и bind, в свойстве this хранится container скроллера, как контекст
				console.log(json);
				
				// сохраняем способ редактирования скроллера в данном контейнере перед копирование
				var add_style = this.data.add_style;
				
				copyDescriptor(json, this.data);
				delete json;
				
				// восстанавливаем способ редактирования после копирования
				this.data.add_style = add_style;
				
				// TODO. Необходимо удалить из added_items записи, которые находятся в полученном items, т.к. это значит, что кто-то уже добавил эту организацию
				var isFound = false;
				var len;
				if(this.data.local_data.added_items) {
					len = this.data.local_data.added_items.length;
					for(var i = 0; i<len; i++) {
						var item = this.data.local_data.added_items[i];
						var itemsLen = this.data.items.length;
						for(var j = 0; j<itemsLen; j++) {
							if(item.fields.id.value == this.data.items[j].fields.id.value) {
								this.data.local_data.added_items.items.splice(i,1);
								isFound = true;
								break;
							}
						}
					}
				}
				// TODO. Необходимо удалить из items записи, которые находятся в deleted_items
				if(this.data.local_data.deleted_items && !isFound) {
					len = data.items.length;
					for(var i = 0; i<len; i++) {
						var item = this.data.local_data.deleted_items[i];
						var itemsLen = this.data.items.length;
						for(var j = 0; j<itemsLen; j++) {
							if(item.fields.id.value == this.data.items[j].fields.id.value) {
								this.data.items.splice(i,1);
								break;
							}
						}
					}
				}
				
				// сохраняем в виде локальных сущностей записи скроллера
				saveScrollerItems(this.data);
				
				renderScroller(this.data);
			}
		}).bind(container),
		error: function(xhr, ajaxOptions, thrownError) {
			console.log(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
			handleAjaxError({
				messages: [{
					title: 'Ошибка обмена данными',
					msg: 'Ошибка обработки запроса на стороне сервера. Обратитесь в службу поддержки',
				}],
			});
		}
	});
}

// клик по номеру страницы
function change_page(container_id, p){
	console.log('p='+p);
	containers[container_id].jqobj.find('#page').val(p);
	console.log('page='+containers[container_id].jqobj.find('#page').val());
	apply_filter(container_id);
}

// клик по сортировке колонки
function change_sort(container_id, id){
	var order = containers[container_id].jqobj.find("#order");
	var sort = containers[container_id].jqobj.find("#sort");
	if(sort.val()==id) order.val() == "DESC" ? order.val("ASC") : order.val("DESC");
	else sort.val(id);
	apply_filter(container_id);
}

// выбор количества строк на странице
function change_page_size(container_id){
	containers[container_id].jqobj.find("#page_size").val(containers[container_id].jqobj.find("select[name='page_sizes']").val());
	apply_filter(container_id);
}

// Очистка бизнес-полей фильтра, запрашивает и выводит отфильтрованные данные
function clear_filter(container_id) {
	var data = containers[container_id].data;
	var columns = containers[container_id].jqobj.find("#" + createUDID(data) + " table tr:eq(2) td");
	for(var i=0;i<columns.length;i++){
		columns.eq(i).find("input[name^='filter_'], select[name^='filter_']").each(function(){
			$(this).val("");
		});
		// TODO: checkbox и пр.
	}
	apply_filter(container_id);
}
//--></script>	</body>
</html>